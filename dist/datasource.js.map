{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","angular","dateMath","TableModel","MAX_AVAILABLE_TOKEN","SumologicDatasource","instanceSettings","$q","backendSrv","templateSrv","timeSrv","type","name","url","basicAuth","withCredentials","timeoutSec","jsonData","timeout","fieldIndex","tagKeys","Set","tagValues","token","tokenTimer","excludeFieldList","clearInterval","options","queries","chain","targets","filter","target","hide","query","map","params","replace","stripComment","scopedVars","from","convertTime","range","to","timeZone","adhocFilters","getAdhocFilters","length","filterQuery","f","operator","key","value","join","indexOf","delay","retryCount","logQuery","format","Math","random","Promise","all","then","result","responses","r","isEmpty","hasAdhocFilter","forEach","fields","includes","add","records","messages","Object","keys","d","tagKey","each","response","index","concat","transformRecordsToTimeSeries","valueOf","tableResponses","flatten","push","transformDataToTable","data","timeRange","recordValuesQuery","match","recordKey","toLowerCase","String","text","annotation","split","titleFormat","textFormat","resolve","eventList","message","tags","v","k","time","parseInt","title","renderTemplate","Date","getTime","status","startTime","doRequest","job","loop","id","now","reject","state","calculateRetryWait","pendingErrors","pendingWarnings","recordCount","limit","min","messageCount","catch","err","code","method","path","ceil","headers","inspect","Authorization","setInterval","provideToken","datasourceRequest","retryable","func","wait","setTimeout","promise","i","table","uniq","columns","c","filterable","row","rows","defaultValue","metricLabel","dps","datapoints","keyField","find","fieldType","valueField","sort","a","b","createMetricLabel","parseFloat","record","isUndefined","aliasFormat","aliasPattern","aliasData","aliasRegex","g1","q","date","roundUp","isString","parse","some","variables","variable","Array","initialWait","pow","floor"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport angular from 'angular';\nimport dateMath from 'app/core/utils/datemath';\nimport TableModel from 'app/core/table_model';\n\n// Rate limiting, https://help.sumologic.com/APIs/Search-Job-API/About-the-Search-Job-API\nconst MAX_AVAILABLE_TOKEN = 4; // 4 api calls per second\n\nexport class SumologicDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv, timeSrv) {\n    this.type = instanceSettings.type;\n    this.name = instanceSettings.name;\n    this.url = instanceSettings.url;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.timeoutSec = instanceSettings.jsonData.timeout || 30;\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.timeSrv = timeSrv;\n    this.fieldIndex = {\n      tagKeys: new Set(),\n      tagValues: {}\n    };\n    this.token = MAX_AVAILABLE_TOKEN;\n    this.tokenTimer = null;\n    this.excludeFieldList = [\n      '_raw', '_collectorid', '_sourceid', '_messageid', '_messagecount', '_messagetime', '_receipttime',\n      '_size', '_timeslice', 'processing_time_ms'\n    ];\n  }\n\n  provideToken() {\n    if (this.token < MAX_AVAILABLE_TOKEN) {\n      this.token += 1;\n      if (this.token === MAX_AVAILABLE_TOKEN) {\n        clearInterval(this.tokenTimer);\n        this.tokenTimer = null;\n      }\n    }\n  }\n\n  query(options) {\n    let queries = _.chain(options.targets)\n      .filter((target) => {\n        return !target.hide && target.query;\n      })\n      .map((target) => {\n        let params = {\n          query: this.templateSrv.replace(this.stripComment(target.query), options.scopedVars),\n          from: this.convertTime(options.range.from, false),\n          to: this.convertTime(options.range.to, true),\n          timeZone: 'Etc/UTC'\n        };\n        let adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n        if (adhocFilters.length > 0) {\n          let filterQuery = ' | where ' + adhocFilters.map(f => {\n            switch (f.operator) {\n              case '=~':\n                return f.key + ' ' + 'matches' + ' \"' + f.value + '\"';\n              case '!~':\n                return '!(' + f.key + ' ' + 'matches' + ' \"' + f.value + '\"' + ')';\n              default:\n                return f.key + ' ' + f.operator + ' \"' + f.value + '\"';\n            }\n          }).join(' and ');\n          if (params.query.indexOf('|') === -1) {\n            params.query += filterQuery;\n          } else {\n            params.query = params.query.replace(/\\|/, filterQuery + ' |');\n          }\n        }\n        return this.delay((retryCount) => {\n          return this.logQuery(params, target.format);\n        }, 0, Math.random() * 1000);\n      }).value();\n\n    return Promise.all(queries).then(responses => {\n      let result = [];\n\n      responses = responses.filter((r) => { return !_.isEmpty(r); });\n\n      if (this.hasAdhocFilter()) {\n        this.fieldIndex = {\n          tagKeys: new Set(),\n          tagValues: {}\n        };\n\n        // build fieldIndex\n        responses.forEach(r => {\n          r.fields.map(f => {\n            return f.name;\n          }).filter(name => {\n            return !this.excludeFieldList.includes(name);\n          }).forEach(name => {\n            this.fieldIndex.tagKeys.add(name);\n          });\n        });\n\n        responses.forEach(r => {\n          (r.records || r.messages).forEach(d => {\n            Object.keys(d.map).filter(tagKey => {\n              return !this.excludeFieldList.includes(tagKey);\n            }).forEach(tagKey => {\n              if (!this.fieldIndex.tagValues[tagKey]) {\n                this.fieldIndex.tagValues[tagKey] = new Set();\n              }\n              this.fieldIndex.tagValues[tagKey].add(d.map[tagKey]);\n            });\n          });\n        });\n      }\n\n      _.each(responses, (response, index) => {\n        if (options.targets[index].format === 'time_series_records') {\n          result = result.concat(this.transformRecordsToTimeSeries(response, options.targets[index], options.range.to.valueOf()));\n        }\n      });\n\n      let tableResponses = _.chain(responses)\n        .filter((response, index) => {\n          return options.targets[index].format === 'records' || options.targets[index].format === 'messages';\n        })\n        .flatten()\n        .value();\n\n      if (tableResponses.length > 0) {\n        result.push(this.transformDataToTable(tableResponses));\n      }\n\n      return { data: result };\n    });\n  }\n\n  metricFindQuery(query) {\n    let range = this.timeSrv.timeRange();\n\n    let recordValuesQuery = query.match(/^record_values\\(([^,]+?),\\s?([^\\)]+?)\\)/);\n    if (recordValuesQuery) {\n      let recordKey = recordValuesQuery[1].toLowerCase();\n      let query = recordValuesQuery[2];\n      let params = {\n        query: this.templateSrv.replace(this.stripComment(query)),\n        from: String(this.convertTime(range.from, false)),\n        to: String(this.convertTime(range.to, true)),\n        timeZone: 'Etc/UTC'\n      };\n      return this.logQuery(params, 'records').then((result) => {\n        if (_.isEmpty(result)) {\n          return [];\n        }\n        return result.records.map((r) => {\n          return {\n            text: r.map[recordKey],\n            value: r.map[recordKey]\n          };\n        })\n      });\n    }\n  }\n\n  annotationQuery(options) {\n    let annotation = options.annotation;\n    let query = annotation.query || '';\n    let tagKeys = annotation.tagKeys || '';\n    tagKeys = tagKeys.split(',');\n    let titleFormat = annotation.titleFormat || '';\n    let textFormat = annotation.textFormat || '';\n\n    if (!query) { return Promise.resolve([]); }\n\n    let params = {\n      query: this.templateSrv.replace(this.stripComment(query)),\n      from: String(this.convertTime(options.range.from, false)),\n      to: String(this.convertTime(options.range.to, true)),\n      timeZone: 'Etc/UTC'\n    };\n    return this.logQuery(params, 'messages').then((result) => {\n      if (_.isEmpty(result)) {\n        return [];\n      }\n\n      let eventList = result.messages.map((message) => {\n        let tags = _.chain(message.map)\n          .filter((v, k) => {\n            return _.includes(tagKeys, k);\n          }).value();\n\n        return {\n          annotation: annotation,\n          time: parseInt(message.map['_messagetime'], 10),\n          title: this.renderTemplate(titleFormat, message.map),\n          tags: tags,\n          text: this.renderTemplate(textFormat, message.map)\n        };\n      });\n\n      return eventList;\n    });\n  }\n\n  testDatasource() {\n    let params = {\n      query: '| count _sourceCategory',\n      from: (new Date()).getTime() - 10 * 60 * 1000,\n      to: (new Date()).getTime(),\n      timeZone: 'Etc/UTC'\n    };\n    return this.logQuery(params, 'records').then((response) => {\n      return { status: 'success', message: 'Data source is working', title: 'Success' };\n    });\n  }\n\n  logQuery(params, format) {\n    let startTime = new Date();\n    return this.doRequest('POST', '/v1/search/jobs', params).then((job) => {\n      let loop = (retryCount) => {\n        return this.doRequest('GET', '/v1/search/jobs/' + job.data.id).then((status) => {\n          let now = new Date();\n          if (now - startTime > (this.timeoutSec * 1000)) {\n            return this.doRequest('DELETE', '/v1/search/jobs/' + job.data.id).then((result) => {\n              return Promise.reject({ message: 'timeout' });\n            });\n          }\n\n          if (status.data.state !== 'DONE GATHERING RESULTS') {\n            if (retryCount < 20) {\n              return this.delay(loop, retryCount + 1, this.calculateRetryWait(1000, retryCount));\n            } else {\n              return Promise.reject({ message: 'max retries exceeded' });\n            }\n          }\n\n          if (!_.isEmpty(status.data.pendingErrors) || !_.isEmpty(status.data.pendingWarnings)) {\n            return Promise.reject({ message: status.data.pendingErrors.concat(status.data.pendingWarnings).join('\\n') });\n          }\n\n          if (format === 'time_series_records' || format === 'records') {\n            if (status.data.recordCount === 0) {\n              return Promise.resolve([]);\n            }\n            let limit = Math.min(10000, status.data.recordCount);\n            return this.doRequest('GET', '/v1/search/jobs/' + job.data.id + '/records?offset=0&limit=' + limit).then((response) => {\n              return response.data;\n            });\n          } else if (format === 'messages') {\n            if (status.data.messageCount === 0) {\n              return Promise.resolve([]);\n            }\n            let limit = Math.min(10000, status.data.messageCount);\n            return this.doRequest('GET', '/v1/search/jobs/' + job.data.id + '/messages?offset=0&limit=' + limit).then((response) => {\n              return response.data;\n            });\n          } else {\n            return Promise.reject({ message: 'unsupported type' });\n          }\n        }).catch((err) => {\n          if (err.data && err.data.code && err.data.code === 'unauthorized') {\n            return Promise.reject(err);\n          }\n          // need to wait until job is created and registered\n          if (retryCount < 6 && err.data && err.data.code && err.data.code === 'searchjob.jobid.invalid') {\n            return this.delay(loop, retryCount + 1, this.calculateRetryWait(1000, retryCount));\n          } else {\n            return Promise.reject(err);\n          }\n        });\n      };\n\n      return this.delay((retryCount) => {\n        return loop(retryCount).then((result) => {\n          return result;\n        });\n      }, 0, 0);\n    });\n  }\n\n  doRequest(method, path, params) {\n    if (this.token === 0) {\n      return this.delay((retryCount) => {\n        return this.doRequest(method, path, params);\n      }, 0, Math.ceil(1000 / MAX_AVAILABLE_TOKEN));\n    }\n\n    let options = {\n      method: method,\n      url: this.url + path,\n      data: params,\n      headers: {},\n      inspect: { type: 'sumologic' }\n    };\n\n    if (this.basicAuth || this.withCredentials) {\n      options.withCredentials = true;\n    }\n    if (this.basicAuth) {\n      options.headers.Authorization = this.basicAuth;\n    }\n    options.headers['Content-Type'] = 'application/json';\n\n    this.token--;\n    if (this.tokenTimer === null) {\n      this.tokenTimer = setInterval(() => {\n        this.provideToken();\n      }, Math.ceil(1000 / MAX_AVAILABLE_TOKEN));\n    }\n\n    return this.backendSrv.datasourceRequest(options).catch((err) => {\n      if (err.data && err.data.code && err.data.code === 'rate.limit.exceeded') {\n        this.token = 0;\n        return this.retryable(3, (retryCount) => {\n          return this.delay((retryCount) => {\n            return this.backendSrv.datasourceRequest(options);\n          }, retryCount, this.calculateRetryWait(1000, retryCount));\n        });\n      } else {\n        return Promise.reject(err);\n      }\n    });\n  }\n\n  delay(func, retryCount, wait) {\n    return new Promise((resolve, reject) => {\n      setTimeout(() => {\n        func(retryCount).then(resolve, reject);\n      }, wait);\n    });\n  }\n\n  retryable(retryCount, func) {\n    let promise = Promise.reject({}).catch(() => func(retryCount));\n    for (let i = 0; i < retryCount; i++) {\n      ((i) => {\n        promise = promise.catch(err => func(i + 1));\n      })(i);\n    }\n    return promise;\n  }\n\n  transformDataToTable(data) {\n    let table = new TableModel();\n\n    if (data.length === 0) {\n      return table;\n    }\n\n    let type = data[0].records ? 'records' : 'messages';\n\n    let fields = _.chain(data)\n      .map((d) => {\n        return _.map(d.fields, 'name');\n      })\n      .flatten().uniq().value();\n\n    // columns\n    table.columns = fields.map((c) => {\n      return { text: c, filterable: true };\n    });\n\n    // rows\n    data.forEach((d) => {\n      for (let r of d[type]) {\n        let row = [];\n        for (let key of fields) {\n          row.push(r.map[key] || '');\n        }\n        table.rows.push(row);\n      }\n    });\n\n    return table;\n  }\n\n  transformRecordsToTimeSeries(response, target, defaultValue) {\n    let metricLabel = '';\n    let dps = [];\n    let fields = response.fields;\n    let records = response.records;\n\n    if (records.length === 0) {\n      return { target: metricLabel, datapoints: dps };\n    }\n\n    let keyField = fields.find((f) => {\n      return f.fieldType != 'string' && f.keyField;\n    });\n    keyField = keyField ? keyField.name : '';\n    let valueField = fields.find((f) => {\n      return f.fieldType != 'string' && !f.keyField;\n    });\n    if (!valueField) {\n      return { target: metricLabel, datapoints: dps };\n    }\n    valueField = valueField.name;\n\n    let result = {};\n    records.sort((a, b) => {\n      if (keyField === '') {\n        return 0;\n      }\n      if (a.map[keyField] < b.map[keyField]) {\n        return -1;\n      } else if (a.map[keyField] > b.map[keyField]) {\n        return 1;\n      } else {\n        return 0;\n      }\n    }).forEach((r) => {\n      metricLabel = this.createMetricLabel(r.map, target);\n      result[metricLabel] = result[metricLabel] || [];\n      result[metricLabel].push([parseFloat(r.map[valueField]), parseFloat(r.map[keyField] || defaultValue)]);\n    });\n\n    return _.map(result, (v, k) => {\n      return { target: k, datapoints: v };\n    });\n  }\n\n  createMetricLabel(record, target) {\n    if (_.isUndefined(target) || _.isEmpty(target.aliasFormat)) {\n      return '';\n    }\n\n    return this.renderTemplate(this.templateSrv.replace(target.aliasFormat), record) || '{}';\n  }\n\n  renderTemplate(aliasPattern, aliasData) {\n    var aliasRegex = /\\{\\{\\s*(.+?)\\s*\\}\\}/g;\n    return aliasPattern.replace(aliasRegex, function (match, g1) {\n      if (aliasData[g1]) {\n        return aliasData[g1];\n      }\n      return g1;\n    });\n  }\n\n  stripComment(query) {\n    return query.split(\"\\n\").map(q => {\n      return q.replace(/(\\/\\*([\\s\\S]*?)\\*\\/)|(\\/\\/(.*)$)/gm, '');\n    }).filter(q => {\n      return q !== \"\";\n    }).join(\"\\n\");\n  }\n\n  convertTime(date, roundUp) {\n    if (_.isString(date)) {\n      date = dateMath.parse(date, roundUp);\n    }\n    return date.valueOf();\n  }\n\n  hasAdhocFilter() {\n    return _.some(this.templateSrv.variables, variable => {\n      return variable.type === 'adhoc';\n    });\n  }\n\n  getTagKeys(options) {\n    return Promise.resolve(Array.from(this.fieldIndex.tagKeys).map(k => {\n      return {\n        type: 'key',\n        text: k\n      };\n    }));\n  }\n\n  getTagValues(options) {\n    return Promise.resolve(Array.from(this.fieldIndex.tagValues[options.key]).map(v => {\n      return {\n        type: 'value',\n        text: v\n      };\n    }));\n  }\n\n  calculateRetryWait(initialWait, retryCount) {\n    return initialWait * Math.min(10, Math.pow(2, retryCount)) +\n      Math.floor(Math.random() * 1000);\n  }\n}\n"]}